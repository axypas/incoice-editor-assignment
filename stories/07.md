# US7 — Auto-save draft invoices

## Story
- **As** a user creating or editing invoices
- **I want** my work to be automatically saved as I type
- **So that** I never lose progress due to connection issues or accidents

## Acceptance Criteria
### Auto-save Behavior
- **Trigger**: Debounced 30 seconds after last change (configurable)
- **Scope**: Save all form data including line items, calculations, notes
- **Status indicators**:
  - "Unsaved changes" (immediately on edit)
  - "Saving..." (during save)
  - "Draft saved at [HH:MM]" (on success)
  - "Failed to save - retrying..." (on failure with automatic retry)
- **Conflict resolution**:
  - If server version is newer, show dialog: "This invoice was modified elsewhere. Keep your version or load the latest?"
  - Preserve both versions for user choice

### Technical Implementation
- **Local storage**: Mirror draft in localStorage for recovery
- **Network-aware**: Queue saves when offline, sync when connection returns
- **Optimistic locking**: Include version/timestamp to detect conflicts
- **Partial saves**: Save only changed fields to minimize payload

## Edge Cases
- **Network interruption** → Continue saving to localStorage, sync when online
- **Browser crash** → On reload, detect and offer to restore from localStorage
- **Concurrent edits** → Conflict dialog with diff view if possible
- **Storage quota** → Graceful degradation with warning: "Auto-save temporarily disabled due to storage limits"
- **Invalid data** → Save anyway but mark as "Draft has validation errors"

## Test Notes
- RTL:
  - Debounce timing (trigger after 30s, reset on new changes)
  - Status indicator transitions
  - LocalStorage backup and restore
  - Conflict resolution dialog
- E2E:
  - Create invoice, wait for auto-save, refresh → data persists
  - Simulate network failure → localStorage fallback
  - Concurrent edit simulation → conflict dialog appears

## Principle Notes
- Empathize Relentlessly:
  - Zero data loss is the goal
  - Clear status communication reduces anxiety
  - Conflict resolution respects user's work
- Embrace Speed:
  - Debounced saves prevent API spam
  - Optimistic UI updates feel instant
- Build Excitement:
  - Subtle "saved" confirmations build trust
  - Recovery from crashes feels magical
- Challenge the Basics:
  - Start with time-based saves; add change detection later if needed