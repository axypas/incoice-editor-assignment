# US4 — Edit draft invoice

## Story
- **As** an accountant
- **I want** to edit draft invoices before finalizing them
- **So that** I can correct mistakes without starting over or losing my work

## Acceptance Criteria
### Edit Action & Form
- **Edit action** visible only on **draft** (non-finalized) invoices in the list
- Click "Edit" → Form opens pre-populated with current values:
  - Customer (searchable dropdown)
  - Invoice date & deadline (date pickers, no future dates for invoice date)
  - Paid checkbox
  - Invoice lines table: Product, Quantity, Label, Unit, VAT Rate, Price, Tax, Actions
- **Finalized invoice constraint**: No "Edit" action visible; if accessed via direct URL, show read-only view with message: "This invoice is finalized and cannot be edited"

### Line Item Management
- **Edit line**: Change quantity, label, VAT rate, price, tax
- **Add line**: Select product → autofills label/unit/VAT/price, user adjusts as needed
- **Remove line**: Click delete icon (requires at least 1 line remaining)
- **Business rule**: Prevent removing last line with tooltip: "Invoice must have at least one line item"

### Validation & Save
- **On blur validation** for each field (red border + inline error for invalid):
  - Required fields marked with asterisk and `aria-required`
  - Date validation: invoice date ≤ deadline
  - Complete sentences: "Deadline must be on or after invoice date"
- **Save button**: Enabled when form is valid and dirty
- Click "Save" → Optimistic update → Success toast "Invoice updated successfully" → Return to list with updated row
- **Totals**: Auto-calculate based on line items changes

### Accessibility
- Focus management: Customer dropdown on form open, first invalid field on validation error
- ESC closes form with "Unsaved changes" confirmation if dirty
- Delete line icons: `aria-label="Remove line item: {product label}"`
- Loading state: "Save" button shows spinner, disabled

## Edge Cases
- **Validation failure** (e.g., deadline before invoice date):
  - Inline error with red border
  - Input preserved, focus on invalid field
  - Save button disabled
- **Network failure** during save:
  - Error toast: "Couldn't save changes — please try again"
  - Form remains open with user's edits intact
  - Console logs full error details (dev only)
- **Concurrent edit** (409 conflict):
  - Toast: "This invoice was updated by someone else. Please refresh and try again."
  - Option to refresh or keep editing (local storage backup)
- **Browser refresh/close**: Restore from local storage backup if unsaved changes exist

## Test Notes
- RTL (with MSW):
  - Happy path: Edit draft, modify fields, save → success
  - Validation: Trigger on blur errors, verify messages and focus
  - Business rules: Attempt to remove last line → prevented
  - Network error: Mock 500 response → error toast, form preserved
  - Concurrent edit: Mock 409 response → conflict handling
- E2E (with page.route):
  - Load list → edit draft → modify customer + line items → save → verify in list
  - Attempt to edit finalized invoice → read-only view
  - Edit draft, close browser, reopen → restore from localStorage

## Technical Notes
- Use `putInvoice` API (schema lines 267-313)
- Update payload structure:
  ```json
  {
    "invoice": {
      "id": 123,
      "customer_id": 456,
      "date": "2021-02-03",
      "deadline": "2021-03-05",
      "paid": false,
      "invoice_lines_attributes": [
        { "id": 789, "quantity": 2, "label": "Updated" },  // update existing
        { "product_id": 67, "quantity": 1 },                // create new
        { "id": 790, "_destroy": true }                     // delete
      ]
    }
  }
  ```
- Local storage backup: Debounced autosave on form change, keyed by `draft-invoice-{id}`
- Clear backup on successful save or form close

## Principle Notes
- Challenge the Basics:
  - No inline editing; focused form for intentional changes
  - Only essential fields (no invoice number override, no bulk mode yet)
- Empathize Relentlessly:
  - Preserve input on error, clear business rule feedback
  - Safe from accidental finalized edits
  - Auto-save to localStorage prevents data loss
- Embrace Speed:
  - Optimistic save with rollback
  - Local storage backup for resilience
- Build Excitement:
  - Auto-calculating totals reduce manual work
  - Success feedback builds confidence
