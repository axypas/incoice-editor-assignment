# US3 — Create a new invoice (enhanced form with line items)

## Story
- **As** a user
- **I want** to create a new draft invoice with dynamic line items
- **So that** I can accurately bill customers with real-time calculations

## Acceptance Criteria
### Core Fields
- **Header**: Customer selector (searchable dropdown), auto-generated invoice number (YYYY-NNN format), date picker (defaults to today), payment terms/deadline picker
- **Line Items**:
  - Dynamic add/remove (minimum 1 required)
  - Fields per line: description, quantity (decimal), unit price, tax rate (%), optional discount (% or fixed), line total
  - Real-time calculation: `line_total = quantity × unit_price × (1 - discount/100) × (1 + tax/100)`
  - "Add line" button, duplicate line action, remove line (if > 1 line)
- **Totals Area**:
  - Auto-calculated subtotal, tax breakdown, grand total
  - Proper decimal precision (2 places for currency)
- **Footer**: Notes/terms text area

### Validation & Error Handling
- **Inline validation** (on field blur, not pre-emptively):
  - Required: customer, invoice number, date, at least 1 line item
  - Quantity > 0 with message "Quantity must be greater than 0"
  - Unit price ≥ 0 with message "Please enter a valid price"
  - Tax rate 0-100% range
  - Date format validation with locale-aware display
- **Error display**:
  - Field-level errors next to inputs with red border and icon
  - Complete sentences explaining issue and fix
  - Preserve ALL user input on validation failure
- **Auto-save draft** every 30 seconds (see US7 for details)
- Save status indicator: "Saving..." → "Draft saved at [time]"

## Edge Cases
- API `422` validation → highlight specific fields with server messages, preserve all input
- Duplicate invoice number → "This invoice number already exists. Please use a different number."
- Network failure → show non-blocking error "Unable to save. Your changes are preserved locally." + retry button
- Decimal precision issues → round calculations to 2 decimal places, validate against server
- Browser refresh/navigation → warn if unsaved changes: "You have unsaved changes. Are you sure you want to leave?"

## Test Notes
- RTL:
  - Happy path with multiple line items and calculations
  - Field validation (blur behavior, error messages)
  - Auto-save trigger and status updates
  - Preserve input on 422 error
- E2E: Create invoice with 3 line items, verify calculations match

## Principle Notes
- Empathize Relentlessly:
  - Never lose user data (local storage backup)
  - Clear, actionable validation messages
  - Positive language ("Please enter" not "You forgot")
  - Auto-save reduces stress of losing work
- Challenge the Basics: Start with essential fields; avoid complex tax rules initially
- Embrace Speed: Real-time calculations provide instant feedback
- Build Excitement: Save status and smooth calculations build confidence
